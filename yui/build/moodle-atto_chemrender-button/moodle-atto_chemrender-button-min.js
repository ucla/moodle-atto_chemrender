YUI.add("moodle-atto_chemrender-button",function(h,f){var e="atto_chemrender",g=0,d={CHEMDOODLE_SKETCHER_OUTPUT:"atto_chemrender_chemdoodle_sketcher_output",CHEMDOODLE_SKETCHER:"atto_chemrender_chemdoodle_sketcher_iframe",ENTRY_CONTAINER:"atto_chemrender_entry_container",FILE_BROWSER:"atto_chemrender_file_browser",FILENAME_INPUT:"atto_chemrender_filename_input",PREVIEW_BUTTON:"atto_chemrender_preview_button",PREVIEW_CHEMDOODLE:"atto_chemrender_preview_chemdoodle_iframe",PREVIEW_CONTAINER:"atto_chemrender_preview_container",PREVIEW_JMOL:"atto_chemrender_preview_jmol",PREVIEW_SKETCHER_BUTTON:"atto_chemrender_preview_sketcher_button",RENDERER_SELECTION:"atto_chemrender_renderer_selection",SUBMIT_BUTTON:"atto_chemrender_submit_button",URL_INPUT:"atto_chemrender_url_input",SIZE_OPTIONS:"atto_chemrender_size_options",OPTION_WIDTH:"atto_chemrender_size_option_width",OPTION_HEIGHT:"atto_chemrender_size_option_height",JMOL_OPTIONS:"atto_chemrender_jmol_options",OPTION_DOWNLOAD_LINK:"atto_chemrender_jmol_option_download_link",OPTION_HELP_LINK:"atto_chemrender_jmol_option_help_link",OPTION_SPIN:"atto_chemrender_jmol_option_spin",OPTION_STYLESELECT:"atto_chemrender_jmol_option_styleselect",OPTION_LABEL:"atto_chemrender_jmol_option_label",OPTION_CONSOLE_COMMANDS:"atto_chemrender_jmol_option_console_commands",OPTION_CONSOLE_COMMANDS_HELPLINK:"atto_chemrender_jmol_option_console_commands_helplink",SPECTRUM_OPTIONS:"atto_chemrender_spectrum_options",OPTION_XAXIS:"atto_chemrender_spectrum_option_xaxis",OPTION_YAXIS:"atto_chemrender_spectrum_option_yaxis"},b={CHEMDOODLE_SKETCHER_OUTPUT:"."+d.CHEMDOODLE_SKETCHER_OUTPUT,CHEMDOODLE_SKETCHER:"."+d.CHEMDOODLE_SKETCHER,FILE_BROWSER:"."+d.FILE_BROWSER,FILENAME_INPUT:"."+d.FILENAME_INPUT,JMOL_OPTIONS:"."+d.JMOL_OPTIONS,OPTION_CONSOLE_COMMANDS:"."+d.OPTION_CONSOLE_COMMANDS,OPTION_DOWNLOAD_LINK:"."+d.OPTION_DOWNLOAD_LINK,OPTION_HEIGHT:"."+d.OPTION_HEIGHT,OPTION_HELP_LINK:"."+d.OPTION_HELP_LINK,OPTION_LABEL:"."+d.OPTION_LABEL,OPTION_SPIN:"."+d.OPTION_SPIN,OPTION_STYLESELECT:"."+d.OPTION_STYLESELECT,OPTION_WIDTH:"."+d.OPTION_WIDTH,OPTION_XAXIS:"."+d.OPTION_XAXIS,OPTION_YAXIS:"."+d.OPTION_YAXIS,PREVIEW_BUTTON:"."+d.PREVIEW_BUTTON,PREVIEW_CHEMDOODLE:"."+d.PREVIEW_CHEMDOODLE,PREVIEW_CONTAINER:"."+d.PREVIEW_CONTAINER,PREVIEW_JMOL:"."+d.PREVIEW_JMOL,PREVIEW_SKETCHER_BUTTON:"."+d.PREVIEW_SKETCHER_BUTTON,RENDERER_SELECTION:"."+d.RENDERER_SELECTION,SIZE_OPTIONS:"."+d.SIZE_OPTIONS,SPECTRUM_OPTIONS:"."+d.SPECTRUM_OPTIONS,SUBMIT_BUTTON:"."+d.SUBMIT_BUTTON,URL_INPUT:"."+d.URL_INPUT},c='<form class="atto_form"><div class="{{CSS.ENTRY_CONTAINER}}"><label for="{{elementid}}_{{CSS.URL_INPUT}}">{{get_string "enterurl" component}}</label><input class="fullwidth {{CSS.URL_INPUT}}" type="url" id="{{elementid}}_{{CSS.URL_INPUT}}" size="32"/><br/>{{#if showFilepicker}}<button class="{{CSS.FILE_BROWSER}}" type="button">{{get_string "browserepositories" component}}</button><br/>{{/if}}<br/><label for="{{elementid}}_{{CSS.OPTION_WIDTH}}" class="sameline">{{get_string "width" component}}</label><input class="{{CSS.OPTION_WIDTH}}" type="number" value="300" id="{{elementid}}_{{CSS.OPTION_WIDTH}}" size="8" min="1" max="1000"/><br/><label for="{{elementid}}_{{CSS.OPTION_HEIGHT}}" class="sameline">{{get_string "height" component}}</label><input class="{{CSS.OPTION_HEIGHT}}" type="number" value="300" id="{{elementid}}_atto_chemrender_height" size="8" min="1" max="1000"/><div class="{{CSS.SIZE_OPTIONS}}"><label for="{{elementid}}_{{CSS.RENDERER_SELECTION}}" class="sameline">{{get_string "rendererselection" component}}</label><select class="{{CSS.RENDERER_SELECTION}}" id="{{elementid}}_{{CSS.RENDERER_SELECTION}}"><option value="chemdoodle">ChemDoodle</option><option value="jmol">JMol</option></select></div><div class="{{CSS.JMOL_OPTIONS}}"><label>{{get_string "jmoloptions" component}}</label><input type="checkbox" class="{{CSS.OPTION_DOWNLOAD_LINK}}" id="{{elementid}}_{{CSS.OPTION_DOWNLOAD_LINK}}" value="1">{{get_string "optiondownloadlink" component}}<br><input type="checkbox" class="{{CSS.OPTION_HELP_LINK}}" id="{{elementid}}_{{CSS.OPTION_HELP_LINK}}" value="1">{{get_string "optionhelplink" component}}<br><input type="checkbox" class="{{CSS.OPTION_SPIN}}" id="{{elementid}}_{{CSS.OPTION_SPIN}}" value="1">{{get_string "optionspin" component}}<br><input type="checkbox" class="{{CSS.OPTION_LABEL}}" id="{{elementid}}_{{CSS.OPTION_LABEL}}" value="1">{{get_string "optionlabel" component}}<br><input type="checkbox" class="{{CSS.OPTION_STYLESELECT}}" id="{{elementid}}_{{CSS.OPTION_STYLESELECT}} value="1">{{get_string "optionstyleselect" component}}<br><label for="{{elementid}}_{{CSS.OPTION_CONSOLE_COMMANDS}}" class="sameline">{{get_string "optionconsolecommand" component}}<span class="helptooltip"><a href="/help.php?component=atto_chemrender&identifier=optionconsolecommand&lang=en" title="{{get_string "optionconsolecommandhelp" component}}" target="_blank"><img class="icon iconhelp {{CSS.OPTION_CONSOLE_COMMANDS_HELPLINK}}" aria-hidden="true" role="presentation" width="16" height="16" src="/lib/editor/atto/plugins/chemrender/pix/help.svg" /></a></span></label><br/><textarea cols="25" rows="3" class="{{CSS.OPTION_CONSOLE_COMMANDS}}" id="{{elementid}}_{{CSS.OPTION_CONSOLE_COMMANDS}}"></textarea> <br/></div><div class="{{CSS.SPECTRUM_OPTIONS}}"><br/><label for="{{elementid}}_{{CSS.OPTION_XAXIS}}" class="sameline">{{get_string "optionaxis" component}}</label><input class="fullwidth {{CSS.OPTION_XAXIS}}" type="text" id="{{elementid}}_{{CSS.OPTION_XAXIS}}" size="32" placeholder="{{get_string "optionxaxis" component}}"/><br/><input class="fullwidth {{CSS.OPTION_YAXIS}}" type="text" id="{{elementid}}_{{CSS.OPTION_YAXIS}}" size="32" placeholder="{{get_string "optionyaxis" component}}"/><br/></div><br/><div class="mdl-align"><button type="button" class="{{CSS.PREVIEW_BUTTON}}">{{get_string "preview" component}}</button></div></div><div class="{{CSS.PREVIEW_CONTAINER}}"><label for="{{elementid}}_{{CSS.PREVIEW_JMOL}}">{{get_string "preview" component}}</label><div describedby="{{elementid}}_cursorinfo" class="{{CSS.PREVIEW_JMOL}}" id="{{elementid}}_{{CSS.PREVIEW_JMOL}}"></div><iframe id="{{elementid}}_{{CSS.PREVIEW_CHEMDOODLE}}" class="{{CSS.PREVIEW_CHEMDOODLE}}"></iframe><br/><div class="mdl-align"><br/><button type="submit" class="{{CSS.SUBMIT_BUTTON}}">{{get_string "submit" component}}</button></div></div></form>',a='<form class="atto_form"><div class="{{CSS.ENTRY_CONTAINER}}"><p/><iframe id="{{elementid}}_{{CSS.CHEMDOODLE_SKETCHER}}" src="/lib/editor/atto/plugins/chemrender/iframe_sketcher.php" name="qualtrics" scrolling="auto" frameborder="no" align="center" height="400px" width="600px"></iframe><br/><label for="{{elementid}}_{{CSS.OPTION_WIDTH}}" class="sameline">{{get_string "width" component}}</label><input class="{{CSS.OPTION_WIDTH}}" type="number" value="300" id="{{elementid}}_{{CSS.OPTION_WIDTH}}" size="8" min="1" max="1000"/><br/><label for="{{elementid}}_{{CSS.OPTION_HEIGHT}}" class="sameline">{{get_string "height" component}}</label><input class="{{CSS.OPTION_HEIGHT}}" type="number" value="300" id="{{elementid}}_{{CSS.OPTION_HEIGHT}}" size="8" min="1" max="1000"/><br/><div class="{{CSS.SIZE_OPTIONS}}"><label for="{{elementid}}_{{CSS.RENDERER_SELECTION}}" class="sameline">{{get_string "rendererselection" component}}</label><select class="{{CSS.RENDERER_SELECTION}}" id="{{elementid}}_{{CSS.RENDERER_SELECTION}}"><option value="chemdoodle">ChemDoodle</option><option value="jmol">JMol</option></select></div><div class="{{CSS.JMOL_OPTIONS}}"><br/><input type="checkbox" class="{{CSS.OPTION_DOWNLOAD_LINK}}" id="{{elementid}}_{{CSS.OPTION_DOWNLOAD_LINK}}" value="1">{{get_string "optiondownloadlink" component}}<br><input type="checkbox" class="{{CSS.OPTION_HELP_LINK}}" id="{{elementid}}_{{CSS.OPTION_HELP_LINK}}" value="1">{{get_string "optionhelplink" component}}<br><input type="checkbox" class="{{CSS.OPTION_SPIN}}" id="{{elementid}}_{{CSS.OPTION_SPIN}}" value="1">{{get_string "optionspin" component}}<br><input type="checkbox" class="{{CSS.OPTION_LABEL}}" id="{{elementid}}_{{CSS.OPTION_LABEL}}" value="1">{{get_string "optionlabel" component}}<br><input type="checkbox" class="{{CSS.OPTION_STYLESELECT}}" id="{{elementid}}_{{CSS.OPTION_STYLESELECT}} value="1">{{get_string "optionstyleselect" component}}<br><label for="{{elementid}}_{{CSS.OPTION_CONSOLE_COMMANDS}}" class="sameline">{{get_string "optionconsolecommand" component}}<span class="helptooltip"><a href="/help.php?component=atto_chemrender&identifier=optionconsolecommand&lang=en" title="{{get_string "optionconsolecommandhelp" component}}" target="_blank"><img class="icon iconhelp {{CSS.OPTION_CONSOLE_COMMANDS_HELPLINK}}" aria-hidden="true" role="presentation" width="16" height="16" src="/lib/editor/atto/plugins/chemrender/pix/help.svg" /></a></span></label><br/><textarea cols="25" rows="3" class="{{CSS.OPTION_CONSOLE_COMMANDS}}" id="{{elementid}}_{{CSS.OPTION_CONSOLE_COMMANDS}}"></textarea> <br/></div><br/><div class="mdl-align"><button type="button" class="{{CSS.PREVIEW_SKETCHER_BUTTON}}">{{get_string "preview" component}}</button></div><input class="fullwidth {{CSS.URL_INPUT}}" type="hidden" id="{{elementid}}_{{CSS.URL_INPUT}}" size="32"/><input class="{{CSS.CHEMDOODLE_SKETCHER_OUTPUT}}" type="hidden" id="{{elementid}}_{{CSS.CHEMDOODLE_SKETCHER_OUTPUT}}" size="32"/></div><div class="{{CSS.PREVIEW_CONTAINER}}"><label for="{{elementid}}_{{CSS.PREVIEW_JMOL}}">{{get_string "preview" component}}</label><br/><div describedby="{{elementid}}_cursorinfo" class="{{CSS.PREVIEW_JMOL}}" id="{{elementid}}_{{CSS.PREVIEW_JMOL}}"></div><iframe id="{{elementid}}_{{CSS.PREVIEW_CHEMDOODLE}}" class="{{CSS.PREVIEW_CHEMDOODLE}}"></iframe><br/><label for="{{elementid}}_{{CSS.FILENAME_INPUT}}">{{get_string "enterfilename" component}}</label><input class="fullwidth {{CSS.FILENAME_INPUT}}" type="text" id="{{elementid}}_{{CSS.FILENAME_INPUT}}" size="32"/><br/><div class="mdl-align"><br/><button type="submit" class="{{CSS.SUBMIT_BUTTON}}">{{get_string "submit" component}}</button></div></div></form>';h.namespace("M.atto_chemrender").Button=h.Base.create("button",h.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_content:null,_fileExtension:["pdb","mol","jdx","cif","cml","csmol","mol2","pdb.gz","pse","sdf","xyz"],_fileExtensionSketcher:["mol"],initializer:function(){if(this.get("host").canShowFilepicker("media")){var j=[];iconfolder=M.cfg.wwwroot+"/lib/editor/atto/plugins/chemrender/ajax.php";url=M.cfg.wwwroot;j.push({text:'<img class="icon" aria-hidden="true" role="presentation" width="16" height="16" style="background-color:transparent;" src="'+url+'/lib/editor/atto/plugins/chemrender/pix/sketcher.svg">ChemDoodle Sketcher',buttonName:"sketcher",callback:this._displaySketcherDialogue,tagMatchRequiresAll:false});j.push({text:'<img class="icon" aria-hidden="true" role="presentation" width="16" height="16" style="background-color:transparent;" src="'+url+'/lib/editor/atto/plugins/chemrender/pix/upload.svg">Insert molecule or spectrum file.',buttonName:"load",callback:this._displayDialogue,tagMatchRequiresAll:false});this.addToolbarMenu({icon:"icon",iconComponent:e,buttonName:"chemRenderMenu",overlayWidth:"4",globalItemConfig:{callback:this._changeStyle},items:j});var m=this.get("group"),n=this.name,i="atto_"+n+"_button",k,l=this.get("host");this._buttonHandlers.push(l.on(["atto:selectionchanged","change"],function(o){this._highlightQueue.chemRenderMenu=h.soon(h.bind(function(p){if(this.selectionFilterMatches("a",p.selectedNodes,false,this._fileExtensionSketcher)){this.highlightButtons("chemRenderMenu")}else{this.unHighlightButtons("chemRenderMenu")}},this,o))},this));this._buttonHandlers.push(l.on(["atto:selectionchanged","change"],function(o){this._highlightQueue.unlink=h.soon(h.bind(function(p){if(this.selectionFilterMatches("a",p.selectedNodes,false,this._fileExtension)){this.highlightButtons("unlink")}else{this.unHighlightButtons("unlink")}},this,o))},this));h.Get.js(["/filter/chemrender/lib/chemdoodle/ChemDoodleWeb.js","/filter/chemrender/lib/chemdoodle/uis/ChemDoodleWeb-uis.js"],function(o){if(o){return}})}},selectionFilterMatches:function(i,p,o,n){var q=this.get("host");if(typeof o==="undefined"){o=true}if(!p){p=q.getSelectedNodes()}var k=p.size()>0,l=false;var m=this.editor,j=function(r){return r===m};if(!m.one(i)){return false}p.each(function(r){if(o){if(!k||!r.ancestor(i,true,j)){k=false}}else{if(!l&&r.ancestor(i,true,j)){fileExtension=r.ancestor().getAttribute("href").split("/").pop().split("?").shift().split(".").pop().toLowerCase();if(n.indexOf(fileExtension)!==-1){l=true}}}},this);if(o){return k}else{return l}},_displayDialogue:function(){this._currentSelection=this.get("host").getSelection();if(this._currentSelection===false||this._currentSelection.collapsed){return}var i=this.getDialogue({headerContent:M.util.get_string("pluginname",e),focusAfterHide:true,width:"auto",focusOnShowSelector:b.URL_INPUT});i.set("bodyContent",this._getDialogueContent());this._resolveAnchors();this._updateOptions();i.show()},_displaySketcherDialogue:function(){this._currentSelection=this.get("host").getSelection();if(this._currentSelection===false||this._currentSelection.collapsed){return}var i=this.getDialogue({headerContent:M.util.get_string("pluginname",e),focusAfterHide:true,width:"auto",focusOnShowSelector:b.URL_INPUT});i.set("bodyContent",this._getSketcherDialogueContent());this._resolveAnchorsSketcher();this._updateOptions();i.show()},_setProperties:function(j,i){if(j!==""){this._content.one(b.URL_INPUT).setAttribute("value",j);this._updateOptions(this)}if(i.hasOwnProperty("width")&&i.width>0){this._content.one(b.OPTION_WIDTH).setAttribute("value",i.width)}else{this._content.one(b.OPTION_WIDTH).setAttribute("value","325")}if(i.hasOwnProperty("height")&&i.height>0){this._content.one(b.OPTION_HEIGHT).setAttribute("value",i.height)}else{this._content.one(b.OPTION_HEIGHT).setAttribute("value","325")}if(i.hasOwnProperty("download-link")){if(i["download-link"]==1){this._content.one(b.OPTION_DOWNLOAD_LINK).set("checked",true)}else{this._content.one(b.OPTION_DOWNLOAD_LINK).set("checked",false)}}if(i.hasOwnProperty("help-link")){if(i["help-link"]==1){this._content.one(b.OPTION_HELP_LINK).set("checked",true)}else{this._content.one(b.OPTION_HELP_LINK).set("checked",false)}}if(i.hasOwnProperty("styleselect")){if(i.styleselect==1){this._content.one(b.OPTION_STYLESELECT).set("checked",true)}else{this._content.one(b.OPTION_STYLESELECT).set("checked",false)}}if(i.hasOwnProperty("spin")){if(i.spin==1){this._content.one(b.OPTION_SPIN).set("checked",true)}else{this._content.one(b.OPTION_SPIN).set("checked",false)}}if(i.hasOwnProperty("label")&&i.label==1){this._content.one(b.OPTION_LABEL).set("checked",true)}else{this._content.one(b.OPTION_LABEL).set("checked",false)}if(i.hasOwnProperty("xaxis")&&i.xaxis!==""){this._content.one(b.OPTION_XAXIS).setAttribute("value",i.xaxis)}if(i.hasOwnProperty("yaxis")&&i.yaxis!==""){this._content.one(b.OPTION_YAXIS).setAttribute("value",i.yaxis)}if(i.hasOwnProperty("renderer")&&i.renderer!==""){this._content.one(b.RENDERER_SELECTION).set("value",i.renderer)}if(i.hasOwnProperty("custom")&&i.custom!==""){document.getElementById(g+"_"+d.OPTION_CONSOLE_COMMANDS).value=i.custom}},_resolveAnchors:function(){var k,p,n=this.get("host").getSelectionParentNode(),o,j;if(!n){return}p=this._findSelectedAnchors(h.one(n));if(p.length>0){k=p[0];this._currentSelection=this.get("host").getSelectionFromNode(k);o=k.getAttribute("target");var m=k.getAttribute("href");var i={};var m=m.split("?");var j=m[0];var l=m[1];if(m.length>1){l.split("&").forEach(function(q){var r=q.split("=");i[r[0]]=decodeURIComponent(r[1])})}this._setProperties(j,i)}},_resolveAnchorsSketcher:function(){var p,j,n,k,m;m=this.get("host").getSelectionParentNode();if(!m){return}j=this._findSelectedAnchors(h.one(m));if(j.length>0){p=j[0];this._currentSelection=this.get("host").getSelectionFromNode(p);n=p.getAttribute("target");var o=p.getAttribute("href");var r={};var o=o.split("?");var k=o[0];var q=o[1];if(o.length>1){q.split("&").forEach(function(s){var t=s.split("=");r[t[0]]=decodeURIComponent(t[1])})}if(k!==""){var i=k.replace(/\\/g,"/");i=i.substring(i.lastIndexOf("/")+1,i.lastIndexOf("."));i=decodeURIComponent(i);this._content.one(b.FILENAME_INPUT).setAttribute("value",i);var l=document.getElementById(g+"_"+d.CHEMDOODLE_SKETCHER);l.onload=function(){var v="#"+g+"_"+d.CHEMDOODLE_SKETCHER;var u=h.one(v);var t=h.Node.getDOMNode(u.get("contentWindow"));var s=t.document;YUI({frame:u,win:t,doc:s}).use("node",function(w){t.clearCanvas();t.setMOL(k)})}}if(r.hasOwnProperty("width")){if(r.width>0){this._content.one(b.OPTION_WIDTH).setAttribute("value",r.width)}}if(r.hasOwnProperty("height")){if(r.height>0){this._content.one(b.OPTION_HEIGHT).setAttribute("value",r.height)}}this._setProperties(k,r)}},_filepickerCallback:function(i){if(i.url!==""){this._content.one(b.URL_INPUT).set("value",i.url);this._updateOptions(this);this.markUpdated()}},_setLink:function(m){var i,p=this.get("host"),n,l,o;m.preventDefault();this.getDialogue({focusAfterHide:null}).hide();n=this._content.one(b.URL_INPUT);o=n.get("value");if(o!==""){this.editor.focus();p.setSelection(this._currentSelection);document.execCommand("unlink",false,null);document.execCommand("createLink",false,o);l=p.getSelectionParentNode();if(!l){return}i=this._findSelectedAnchors(h.one(l));var j=[],k;var q=function(s){var t=[];for(var r in s){if(s.hasOwnProperty(r)){t.push(encodeURIComponent(r)+"="+encodeURIComponent(s[r]))}}return t.join("&")};h.Array.each(i,function(r){j=this._getParam();k=o+"?"+q(j);r.setAttribute("href",k);r.set("innerHTML",decodeURIComponent(o.split("/").pop()))},this);this.markUpdated()}},_setSketcherLink:function(y){var j,z,x,t;var q="#"+g+"_"+d.CHEMDOODLE_SKETCHER;var p=h.one(q);var n=h.Node.getDOMNode(p.get("contentWindow"));var A=n.document;YUI({frame:p,win:n,doc:A}).use("node",function(i){z=n.getMOL()});var k=new Blob([z],{type:"plain/text"});var s=this._content.one(b.FILENAME_INPUT);var v=s.get("value");if(v==""){alert("Filename required")}else{var r=this.get("host");var m=r.get("filepickeroptions").image;var l=(m.savepath===undefined)?"/":m.savepath;var u=new FormData();u.append("repo_upload_file",k,v+".mol");u.append("itemid",m.itemid);var w=0;while(true){if(m.repositories[++w]===undefined){break}if(m.repositories[w].type==="upload"){u.append("repo_id",m.repositories[w].id);break}}u.append("env",m.env);u.append("sesskey",M.cfg.sesskey);u.append("client_id",m.client_id);u.append("savepath",l);u.append("ctx_id",m.context.id);var o=new XMLHttpRequest();o.onreadystatechange=function(){if(o.readyState===4){if(o.status===200){var i=JSON.parse(o.responseText);if(i){if(i.error){return new M.core.ajaxException(i)}var B=i;if(i.event&&i.event==="fileexists"){B=i.newfile}t=B.url;if(t!==""){y.preventDefault();this.getDialogue({focusAfterHide:null}).hide();var C=this.get("host");this.editor.focus();C.setSelection(this._currentSelection);document.execCommand("unlink",false,null);document.execCommand("createLink",false,t);x=C.getSelectionParentNode();if(!x){return}j=this._findSelectedAnchors(h.one(x));var E=[],D;serialize=function(G){var H=[];for(var F in G){if(G.hasOwnProperty(F)){H.push(encodeURIComponent(F)+"="+encodeURIComponent(G[F]))}}return H.join("&")};h.Array.each(j,function(F){E=this._getParam();D=t+"?"+serialize(E);F.setAttribute("href",D);F.set("innerHTML",decodeURIComponent(t.split("/").pop()))},this);this.markUpdated()}}}else{alert(M.util.get_string("servererror","moodle"))}}}.bind(this);o.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload",false);o.send(u);return false}},_getParam:function(){var k=[],j,i;j=this._content.one(b.OPTION_WIDTH);if(j.get("value")){k.width=j.get("value")}j=this._content.one(b.OPTION_HEIGHT);if(j.get("value")){k.height=j.get("value")}j=this._content.one(b.OPTION_DOWNLOAD_LINK);if(j&&j.get("checked")){k["download-link"]=1}j=this._content.one(b.OPTION_HELP_LINK);if(j&&j.get("checked")){k["help-link"]=1}j=this._content.one(b.OPTION_SPIN);if(j&&j.get("checked")){k.spin=1}j=this._content.one(b.OPTION_STYLESELECT);if(j&&j.get("checked")){k.styleselect=1}j=this._content.one(b.OPTION_LABEL);if(j&&j.get("checked")){k.label=1}j=this._content.one(b.OPTION_XAXIS);if(j&&j.get("value")){i=j.get("value");k.xaxis=i}j=this._content.one(b.OPTION_YAXIS);if(j&&j.get("value")){i=j.get("value");k.yaxis=i}j=this._content.one(b.RENDERER_SELECTION);if(j.get("value")){k.renderer=j.get("value")}j=this._content.one(b.OPTION_CONSOLE_COMMANDS);if(j.get("value")){i=j.get("value");i=i.replace(/[^a-zA-Z0-9ά-ωΑ-ώ\ \(\)\[\]\/\\\.\,\;\{\}\:]/gi,"");k.custom=i}return k},_updatePreview:function(n){var m,o,l,i,k,j,p;o=this._content.one(b.URL_INPUT);p=o.get("value");if(p!==""){var q=function(s){var t=[];for(var r in s){if(s.hasOwnProperty(r)){t.push(encodeURIComponent(r)+"="+encodeURIComponent(s[r]))}}return t.join("&")};i=this._getParam();j=p+"?"+q(i);l='<a href="'+j+'">test</a>';m=M.cfg.wwwroot+"/lib/editor/atto/plugins/chemrender/ajax.php";k={sesskey:M.cfg.sesskey,contextid:this.get("contextid"),action:"filtertext",text:l};h.io(m,{context:this,data:k,timeout:500,on:{complete:this._loadPreview}})}},_updateSketcherPreview:function(n){var m,o,j,l,k,r,i,p;o=this._content.one(b.CHEMDOODLE_SKETCHER_OUTPUT);p=o.get("value");if(p!==""){var q=function(t){var u=[];for(var s in t){if(t.hasOwnProperty(s)){u.push(encodeURIComponent(s)+"="+encodeURIComponent(t[s]))}}return u.join("&")};j=this._getParam();r=p;i=window.location.origin;k=i+"/chemdoodle/preview.mol?"+q(j);m=M.cfg.wwwroot+"/lib/editor/atto/plugins/chemrender/ajax_sketcher.php";l={sesskey:M.cfg.sesskey,contextid:this.get("contextid"),action:"filtertext",paramstring:k,sketcheroutput:r};h.io(m,{method:"POST",context:this,data:l,timeout:500,on:{complete:this._loadPreview}})}},_updateOptions:function(l){var i,k;i=this._content.one(b.URL_INPUT);k=i.get("value").toLowerCase();this._content.all(b.SPECTRUM_OPTIONS).each(function(m){m.hide()});this._content.all(b.JMOL_OPTIONS).each(function(m){m.hide()});this._content.all(b.SIZE_OPTIONS).each(function(m){m.hide()});if(k.indexOf(".jdx")!=-1){this._content.all(b.SPECTRUM_OPTIONS).each(function(m){m.show()})}else{if(k.indexOf(".pdb")!=-1||k.indexOf(".cif")!=-1){this._content.all(b.JMOL_OPTIONS).each(function(m){m.show()})}else{if(k.indexOf(".mol")!=-1){this._content.all(b.SIZE_OPTIONS).each(function(m){m.show()})}else{this._content.all(b.SIZE_OPTIONS).each(function(m){m.show()})}}}var j=this._content.one(b.RENDERER_SELECTION);if(j.get("value")){if(j.get("value")=="jmol"){this._content.all(b.JMOL_OPTIONS).each(function(m){m.show()})}}},_loadPreview:function(i,q){var l=this._content.one(b.PREVIEW_JMOL);var r=this._content.one(b.RENDERER_SELECTION).get("value");var z=this._content.one(b.URL_INPUT).get("value").split(".").pop().toLowerCase();if(z=="pdb"||r=="jmol"){l.setHTML(q.responseText);var v=l.getElementsByTagName("script");var x=document.createElement("script");x.type="text/javascript";var t=[];for(var k=0;k<v._nodes.length;k++){if(v._nodes[k].src!=""){t.push(v._nodes[k].src)}else{x.text=x.text+"\n"+v._nodes[k].innerHTML}v._nodes[k].parentNode.removeChild(v._nodes[k])}h.Get.js(t,function(n){if(n){console.log("Error loading JS: "+n[0].error,"error");return}l.appendChild(x)});this._content.all(b.PREVIEW_CONTAINER).each(function(n){n.show()});this._content.all(b.PREVIEW_CHEMDOODLE).each(function(n){n.hide()});this._content.all(b.PREVIEW_JMOL).each(function(n){n.show()})}else{l.setHTML(q.responseText);var v=l.getElementsByTagName("script");var x=document.createElement("script");x.type="text/javascript";var t=[];for(var k=0;k<v._nodes.length;k++){if(v._nodes[k].src!=""){t.push(v._nodes[k].src)}else{x.text=x.text+"\n"+v._nodes[k].innerHTML}v._nodes[k].parentNode.removeChild(v._nodes[k])}var o=l.get("innerHTML");l.setHTML("");t.push("/theme/yui_combo.php?rollup/3.15.0_1/yui-moodlesimple.js");var s="#"+g+"_"+d.PREVIEW_CHEMDOODLE;var j=h.one(s);var p=h.Node.getDOMNode(j.get("contentWindow"));var w=p.document;YUI({frame:j,win:p,doc:w}).use("node",function(y){var A=y.one("body");var n=y.one("head");A.get("childNodes").remove();A.append(o);t.forEach(function(C){var B=document.createElement("script");B.type="text/javascript";B.src=C;B.defer="defer";n.appendChild(B)});setTimeout(function(){A.appendChild(x);var C;var B;C=w.body.scrollHeight;B=w.body.scrollWidth;j.set("height",(C)+"px");j.set("width",(B)+"px")},500)});this._content.all(b.PREVIEW_CONTAINER).each(function(n){n.show()});this._content.all(b.PREVIEW_JMOL).each(function(n){n.hide()});this._content.all(b.PREVIEW_CHEMDOODLE).each(function(n){n.show()})}h.fire(M.core.event.FILTER_CONTENT_UPDATED,{nodes:(new h.NodeList(l))});var u=document.getElementsByClassName("moodle-dialogue-focused");var m=u[0];m.style.left=((window.innerWidth/2)-(m.offsetWidth/2))+"px"},_sketcherPreview:function(m){var i;var o="#"+g+"_"+d.CHEMDOODLE_SKETCHER;var n=h.one(o);var l=h.Node.getDOMNode(n.get("contentWindow"));var k=l.document;YUI({frame:n,win:l,doc:k}).use("node",function(p){i=l.getMOL()});var j=h.one("#"+g+"_"+d.CHEMDOODLE_SKETCHER_OUTPUT);j.set("value",i);this._updateSketcherPreview(this);return false},_findSelectedAnchors:function(k){var l,i,j=k.get("tagName");if(j&&j.toLowerCase()==="a"){return[k]}i=[];k.all("a").each(function(m){if(!l&&this.get("host").selectionContainsNode(m)){i.push(m)}},this);if(i.length>0){return i}l=k.ancestor("a");if(l){return[l]}return[]},_getDialogueContent:function(){var i=this.get("host").canShowFilepicker("link"),j=h.Handlebars.compile(c);g=Math.round(Math.random()*1000000000);this._content=h.Node.create(j({elementid:g,showFilepicker:i,component:e,CSS:d}));this._content.one(b.PREVIEW_BUTTON).on("click",this._updatePreview,this);this._content.one(b.URL_INPUT).on("valuechange",this._updateOptions,this);this._content.one(b.RENDERER_SELECTION).on("valuechange",this._updateOptions,this);this._content.one(b.SUBMIT_BUTTON).on("click",this._setLink,this);if(i){this._content.one(b.FILE_BROWSER).on("click",function(k){k.preventDefault();this.get("host").showFilepicker("link",this._filepickerCallback,this)},this)}this._content.all(b.PREVIEW_CONTAINER).each(function(k){k.hide()});return this._content},_getSketcherDialogueContent:function(){var i=this.get("host").canShowFilepicker("link"),j=h.Handlebars.compile(a);g=Math.round(Math.random()*1000000000);this._content=h.Node.create(j({elementid:g,showFilepicker:i,component:e,CSS:d}));this._content.one(b.PREVIEW_SKETCHER_BUTTON).on("click",this._sketcherPreview,this);this._content.one(b.RENDERER_SELECTION).on("valuechange",this._updateOptions,this);this._content.one(b.SUBMIT_BUTTON).on("click",this._setSketcherLink,this);this._content.all(b.PREVIEW_CONTAINER).each(function(k){k.hide()});return this._content}},{ATTRS:{contextid:{value:null}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin","moodle-core-event","io","event-valuechange","array-extras"]});