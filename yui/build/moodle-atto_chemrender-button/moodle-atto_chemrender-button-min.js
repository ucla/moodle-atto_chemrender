YUI.add("moodle-atto_chemrender-button",function(e,t){var n="atto_chemrender",r=0,i={CHEMDOODLE_SKETCHER_OUTPUT:"atto_chemrender_chemdoodle_sketcher_output",CHEMDOODLE_SKETCHER:"atto_chemrender_chemdoodle_sketcher_iframe",ENTRY_CONTAINER:"atto_chemrender_entry_container",FILE_BROWSER:"atto_chemrender_file_browser",FILENAME_INPUT:"atto_chemrender_filename_input",PREVIEW_BUTTON:"atto_chemrender_preview_button",PREVIEW_CHEMDOODLE:"atto_chemrender_preview_chemdoodle_iframe",PREVIEW_CONTAINER:"atto_chemrender_preview_container",PREVIEW_JMOL:"atto_chemrender_preview_jmol",PREVIEW_SKETCHER_BUTTON:"atto_chemrender_preview_sketcher_button",RENDERER_SELECTION:"atto_chemrender_renderer_selection",SUBMIT_BUTTON:"atto_chemrender_submit_button",URL_INPUT:"atto_chemrender_url_input",SIZE_OPTIONS:"atto_chemrender_size_options",OPTION_WIDTH:"atto_chemrender_size_option_width",OPTION_HEIGHT:"atto_chemrender_size_option_height",JMOL_OPTIONS:"atto_chemrender_jmol_options",OPTION_DOWNLOAD_LINK:"atto_chemrender_jmol_option_download_link",OPTION_HELP_LINK:"atto_chemrender_jmol_option_help_link",OPTION_SPIN:"atto_chemrender_jmol_option_spin",OPTION_STYLESELECT:"atto_chemrender_jmol_option_styleselect",OPTION_LABEL:"atto_chemrender_jmol_option_label",OPTION_CONSOLE_COMMANDS:"atto_chemrender_jmol_option_console_commands",OPTION_CONSOLE_COMMANDS_HELPLINK:"atto_chemrender_jmol_option_console_commands_helplink",SPECTRUM_OPTIONS:"atto_chemrender_spectrum_options",OPTION_XAXIS:"atto_chemrender_spectrum_option_xaxis",OPTION_YAXIS:"atto_chemrender_spectrum_option_yaxis"},s={CHEMDOODLE_SKETCHER_OUTPUT:"."+i.CHEMDOODLE_SKETCHER_OUTPUT,CHEMDOODLE_SKETCHER:"."+i.CHEMDOODLE_SKETCHER,FILE_BROWSER:"."+i.FILE_BROWSER,FILENAME_INPUT:"."+i.FILENAME_INPUT,JMOL_OPTIONS:"."+i.JMOL_OPTIONS,OPTION_CONSOLE_COMMANDS:"."+i.OPTION_CONSOLE_COMMANDS,OPTION_DOWNLOAD_LINK:"."+i.OPTION_DOWNLOAD_LINK,OPTION_HEIGHT:"."+i.OPTION_HEIGHT,OPTION_HELP_LINK:"."+i.OPTION_HELP_LINK,OPTION_LABEL:"."+i.OPTION_LABEL,OPTION_SPIN:"."+i.OPTION_SPIN,OPTION_STYLESELECT:"."+i.OPTION_STYLESELECT,OPTION_WIDTH:"."+i.OPTION_WIDTH,OPTION_XAXIS:"."+i.OPTION_XAXIS,OPTION_YAXIS:"."+i.OPTION_YAXIS,PREVIEW_BUTTON:"."+i.PREVIEW_BUTTON,PREVIEW_CHEMDOODLE:"."+i.PREVIEW_CHEMDOODLE,PREVIEW_CONTAINER:"."+i.PREVIEW_CONTAINER,PREVIEW_JMOL:"."+i.PREVIEW_JMOL,PREVIEW_SKETCHER_BUTTON:"."+i.PREVIEW_SKETCHER_BUTTON,RENDERER_SELECTION:"."+i.RENDERER_SELECTION,SIZE_OPTIONS:"."+i.SIZE_OPTIONS,SPECTRUM_OPTIONS:"."+i.SPECTRUM_OPTIONS,SUBMIT_BUTTON:"."+i.SUBMIT_BUTTON,URL_INPUT:"."+i.URL_INPUT},o='<form class="atto_form"><div class="{{CSS.ENTRY_CONTAINER}}"><label for="{{elementid}}_{{CSS.URL_INPUT}}">{{get_string "enterurl" component}}</label><input class="fullwidth {{CSS.URL_INPUT}}" type="url" id="{{elementid}}_{{CSS.URL_INPUT}}" size="32"/><br/>{{#if showFilepicker}}<button class="{{CSS.FILE_BROWSER}}" type="button">{{get_string "browserepositories" component}}</button><br/>{{/if}}<br/><label for="{{elementid}}_{{CSS.OPTION_WIDTH}}" class="sameline">{{get_string "width" component}}</label><input class="{{CSS.OPTION_WIDTH}}" type="number" value="300" id="{{elementid}}_{{CSS.OPTION_WIDTH}}" size="8" min="1" max="1000"/><br/><label for="{{elementid}}_{{CSS.OPTION_HEIGHT}}" class="sameline">{{get_string "height" component}}</label><input class="{{CSS.OPTION_HEIGHT}}" type="number" value="300" id="{{elementid}}_atto_chemrender_height" size="8" min="1" max="1000"/><div class="{{CSS.SIZE_OPTIONS}}"><label for="{{elementid}}_{{CSS.RENDERER_SELECTION}}" class="sameline">{{get_string "rendererselection" component}}</label><select class="{{CSS.RENDERER_SELECTION}}" id="{{elementid}}_{{CSS.RENDERER_SELECTION}}"><option value="chemdoodle">ChemDoodle</option><option value="jmol">JMol</option></select></div><div class="{{CSS.JMOL_OPTIONS}}"><label>{{get_string "jmoloptions" component}}</label><input type="checkbox" class="{{CSS.OPTION_DOWNLOAD_LINK}}" id="{{elementid}}_{{CSS.OPTION_DOWNLOAD_LINK}}" value="1">{{get_string "optiondownloadlink" component}}<br><input type="checkbox" class="{{CSS.OPTION_HELP_LINK}}" id="{{elementid}}_{{CSS.OPTION_HELP_LINK}}" value="1">{{get_string "optionhelplink" component}}<br><input type="checkbox" class="{{CSS.OPTION_SPIN}}" id="{{elementid}}_{{CSS.OPTION_SPIN}}" value="1">{{get_string "optionspin" component}}<br><input type="checkbox" class="{{CSS.OPTION_LABEL}}" id="{{elementid}}_{{CSS.OPTION_LABEL}}" value="1">{{get_string "optionlabel" component}}<br><input type="checkbox" class="{{CSS.OPTION_STYLESELECT}}" id="{{elementid}}_{{CSS.OPTION_STYLESELECT}} value="1">{{get_string "optionstyleselect" component}}<br><label for="{{elementid}}_{{CSS.OPTION_CONSOLE_COMMANDS}}" class="sameline">{{get_string "optionconsolecommand" component}}<span class="helptooltip"><a href="/help.php?component=atto_chemrender&identifier=optionconsolecommand&lang=en" title="{{get_string "optionconsolecommandhelp" component}}" target="_blank"><img class="icon iconhelp {{CSS.OPTION_CONSOLE_COMMANDS_HELPLINK}}" aria-hidden="true" role="presentation" width="16" height="16" src="{{wwwroot}}/lib/editor/atto/plugins/chemrender/pix/help.svg" /></a></span></label><br/><textarea cols="25" rows="3" class="{{CSS.OPTION_CONSOLE_COMMANDS}}" id="{{elementid}}_{{CSS.OPTION_CONSOLE_COMMANDS}}"></textarea> <br/></div><div class="{{CSS.SPECTRUM_OPTIONS}}"><br/><label for="{{elementid}}_{{CSS.OPTION_XAXIS}}" class="sameline">{{get_string "optionaxis" component}}</label><input class="fullwidth {{CSS.OPTION_XAXIS}}" type="text" id="{{elementid}}_{{CSS.OPTION_XAXIS}}" size="32" placeholder="{{get_string "optionxaxis" component}}"/><br/><input class="fullwidth {{CSS.OPTION_YAXIS}}" type="text" id="{{elementid}}_{{CSS.OPTION_YAXIS}}" size="32" placeholder="{{get_string "optionyaxis" component}}"/><br/></div><br/><div class="mdl-align"><button type="button" class="{{CSS.PREVIEW_BUTTON}}">{{get_string "preview" component}}</button></div></div><div class="{{CSS.PREVIEW_CONTAINER}}"><label for="{{elementid}}_{{CSS.PREVIEW_JMOL}}">{{get_string "preview" component}}</label><div describedby="{{elementid}}_cursorinfo" class="{{CSS.PREVIEW_JMOL}}" id="{{elementid}}_{{CSS.PREVIEW_JMOL}}"></div><iframe id="{{elementid}}_{{CSS.PREVIEW_CHEMDOODLE}}" class="{{CSS.PREVIEW_CHEMDOODLE}}"></iframe><br/><div class="mdl-align"><br/><button type="submit" class="{{CSS.SUBMIT_BUTTON}}">{{get_string "submit" component}}</button></div></div></form>'
,u='<form class="atto_form"><div class="{{CSS.ENTRY_CONTAINER}}"><p/><iframe id="{{elementid}}_{{CSS.CHEMDOODLE_SKETCHER}}" src="{{wwwroot}}/lib/editor/atto/plugins/chemrender/iframe_sketcher.php" name="qualtrics" scrolling="auto" frameborder="no" align="center" height="400px" width="600px"></iframe><br/><label for="{{elementid}}_{{CSS.OPTION_WIDTH}}" class="sameline">{{get_string "width" component}}</label><input class="{{CSS.OPTION_WIDTH}}" type="number" value="300" id="{{elementid}}_{{CSS.OPTION_WIDTH}}" size="8" min="1" max="1000"/><br/><label for="{{elementid}}_{{CSS.OPTION_HEIGHT}}" class="sameline">{{get_string "height" component}}</label><input class="{{CSS.OPTION_HEIGHT}}" type="number" value="300" id="{{elementid}}_{{CSS.OPTION_HEIGHT}}" size="8" min="1" max="1000"/><br/><div class="{{CSS.SIZE_OPTIONS}}"><label for="{{elementid}}_{{CSS.RENDERER_SELECTION}}" class="sameline">{{get_string "rendererselection" component}}</label><select class="{{CSS.RENDERER_SELECTION}}" id="{{elementid}}_{{CSS.RENDERER_SELECTION}}"><option value="chemdoodle">ChemDoodle</option><option value="jmol">JMol</option></select></div><div class="{{CSS.JMOL_OPTIONS}}"><br/><input type="checkbox" class="{{CSS.OPTION_DOWNLOAD_LINK}}" id="{{elementid}}_{{CSS.OPTION_DOWNLOAD_LINK}}" value="1">{{get_string "optiondownloadlink" component}}<br><input type="checkbox" class="{{CSS.OPTION_HELP_LINK}}" id="{{elementid}}_{{CSS.OPTION_HELP_LINK}}" value="1">{{get_string "optionhelplink" component}}<br><input type="checkbox" class="{{CSS.OPTION_SPIN}}" id="{{elementid}}_{{CSS.OPTION_SPIN}}" value="1">{{get_string "optionspin" component}}<br><input type="checkbox" class="{{CSS.OPTION_LABEL}}" id="{{elementid}}_{{CSS.OPTION_LABEL}}" value="1">{{get_string "optionlabel" component}}<br><input type="checkbox" class="{{CSS.OPTION_STYLESELECT}}" id="{{elementid}}_{{CSS.OPTION_STYLESELECT}} value="1">{{get_string "optionstyleselect" component}}<br><label for="{{elementid}}_{{CSS.OPTION_CONSOLE_COMMANDS}}" class="sameline">{{get_string "optionconsolecommand" component}}<span class="helptooltip"><a href="/help.php?component=atto_chemrender&identifier=optionconsolecommand&lang=en" title="{{get_string "optionconsolecommandhelp" component}}" target="_blank"><img class="icon iconhelp {{CSS.OPTION_CONSOLE_COMMANDS_HELPLINK}}" aria-hidden="true" role="presentation" width="16" height="16" src="{{wwwroot}}/lib/editor/atto/plugins/chemrender/pix/help.svg" /></a></span></label><br/><textarea cols="25" rows="3" class="{{CSS.OPTION_CONSOLE_COMMANDS}}" id="{{elementid}}_{{CSS.OPTION_CONSOLE_COMMANDS}}"></textarea> <br/></div><br/><div class="mdl-align"><button type="button" class="{{CSS.PREVIEW_SKETCHER_BUTTON}}">{{get_string "preview" component}}</button></div><input class="fullwidth {{CSS.URL_INPUT}}" type="hidden" id="{{elementid}}_{{CSS.URL_INPUT}}" size="32"/><input class="{{CSS.CHEMDOODLE_SKETCHER_OUTPUT}}" type="hidden" id="{{elementid}}_{{CSS.CHEMDOODLE_SKETCHER_OUTPUT}}" size="32"/></div><div class="{{CSS.PREVIEW_CONTAINER}}"><label for="{{elementid}}_{{CSS.PREVIEW_JMOL}}">{{get_string "preview" component}}</label><br/><div describedby="{{elementid}}_cursorinfo" class="{{CSS.PREVIEW_JMOL}}" id="{{elementid}}_{{CSS.PREVIEW_JMOL}}"></div><iframe id="{{elementid}}_{{CSS.PREVIEW_CHEMDOODLE}}" class="{{CSS.PREVIEW_CHEMDOODLE}}"></iframe><br/><label for="{{elementid}}_{{CSS.FILENAME_INPUT}}">{{get_string "enterfilename" component}}</label><input class="fullwidth {{CSS.FILENAME_INPUT}}" type="text" id="{{elementid}}_{{CSS.FILENAME_INPUT}}" size="32"/><br/><div class="mdl-align"><br/><button type="submit" class="{{CSS.SUBMIT_BUTTON}}">{{get_string "submit" component}}</button></div></div></form>';e.namespace("M.atto_chemrender").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_content:null,_fileExtension:["pdb","mol","jdx","cif","cml","csmol","mol2","pdb.gz","pse","sdf","xyz"],_fileExtensionSketcher:["mol"],initializer:function(){if(this.get("host").canShowFilepicker("media")&&this.get("chemrenderfilteractive")){var t=[];iconfolder=M.cfg.wwwroot+"/lib/editor/atto/plugins/chemrender/ajax.php",url=M.cfg.wwwroot,t.push({text:'<img class="icon" aria-hidden="true" role="presentation" width="16" height="16" style="background-color:transparent;" src="'+url+'/lib/editor/atto/plugins/chemrender/pix/sketcher.svg">ChemDoodle Sketcher',buttonName:"sketcher",callback:this._displaySketcherDialogue,tagMatchRequiresAll:!1}),t.push({text:'<img class="icon" aria-hidden="true" role="presentation" width="16" height="16" style="background-color:transparent;" src="'+url+'/lib/editor/atto/plugins/chemrender/pix/upload.svg">Insert molecule or spectrum file.',buttonName:"load",callback:this._displayDialogue,tagMatchRequiresAll:!1}),this.addToolbarMenu({icon:"icon",iconComponent:n,buttonName:"chemRenderMenu",overlayWidth:"4",globalItemConfig:{callback:this._changeStyle},items:t});var r=this.get("group"),i=this.name,s="atto_"+i+"_button",o,u=this.get("host");this._buttonHandlers.push(u.on(["atto:selectionchanged","change"],function(t){this._highlightQueue.chemRenderMenu=e.soon(e.bind(function(e){this.selectionFilterMatches("a",e.selectedNodes,!1,this._fileExtensionSketcher)?this.highlightButtons("chemRenderMenu"):this.unHighlightButtons("chemRenderMenu")},this,t))},this)),this._buttonHandlers.push(u.on(["atto:selectionchanged","change"],function(t){this._highlightQueue.unlink=e.soon(e.bind(function(e){this.selectionFilterMatches("a",e.selectedNodes,!1,this._fileExtension)?this.highlightButtons("unlink"):this.unHighlightButtons("unlink")},this,t))},this))}},selectionFilterMatches:function(e,t,n,r){var i=this.get("host");typeof n=="undefined"&&(n=!0),t||(t=i.getSelectedNodes());var s=t.size()>0,o=!1,u=this.editor,a=function(e){return e===u};return u.one(e)?(t.each(function(t){if(
n){if(!s||!t.ancestor(e,!0,a))s=!1}else!o&&t.ancestor(e,!0,a)&&(fileExtension=t.ancestor().getAttribute("href").split("/").pop().split("?").shift().split(".").pop().toLowerCase(),r.indexOf(fileExtension)!==-1&&(o=!0))},this),n?s:o):!1},_displayDialogue:function(){this._currentSelection=this.get("host").getSelection();if(this._currentSelection===!1||this._currentSelection.collapsed)return;var e=this.getDialogue({headerContent:M.util.get_string("pluginname",n),focusAfterHide:!0,width:"auto",focusOnShowSelector:s.URL_INPUT});e.set("bodyContent",this._getDialogueContent()),this._resolveAnchors(),this._updateOptions(),e.show()},_displaySketcherDialogue:function(){this._currentSelection=this.get("host").getSelection();if(this._currentSelection===!1||this._currentSelection.collapsed)return;var e=this.getDialogue({headerContent:M.util.get_string("pluginname",n),focusAfterHide:!0,width:"auto",focusOnShowSelector:s.URL_INPUT});e.set("bodyContent",this._getSketcherDialogueContent()),this._resolveAnchorsSketcher(),this._updateOptions(),e.show()},_setProperties:function(e,t){e!==""&&(this._content.one(s.URL_INPUT).setAttribute("value",e),this._updateOptions(this)),t.hasOwnProperty("width")&&t.width>0?this._content.one(s.OPTION_WIDTH).setAttribute("value",t.width):this._content.one(s.OPTION_WIDTH).setAttribute("value","325"),t.hasOwnProperty("height")&&t.height>0?this._content.one(s.OPTION_HEIGHT).setAttribute("value",t.height):this._content.one(s.OPTION_HEIGHT).setAttribute("value","325"),t.hasOwnProperty("download-link")&&(t["download-link"]==1?this._content.one(s.OPTION_DOWNLOAD_LINK).set("checked",!0):this._content.one(s.OPTION_DOWNLOAD_LINK).set("checked",!1)),t.hasOwnProperty("help-link")&&(t["help-link"]==1?this._content.one(s.OPTION_HELP_LINK).set("checked",!0):this._content.one(s.OPTION_HELP_LINK).set("checked",!1)),t.hasOwnProperty("styleselect")&&(t["styleselect"]==1?this._content.one(s.OPTION_STYLESELECT).set("checked",!0):this._content.one(s.OPTION_STYLESELECT).set("checked",!1)),t.hasOwnProperty("spin")&&(t["spin"]==1?this._content.one(s.OPTION_SPIN).set("checked",!0):this._content.one(s.OPTION_SPIN).set("checked",!1)),t.hasOwnProperty("label")&&t["label"]==1?this._content.one(s.OPTION_LABEL).set("checked",!0):this._content.one(s.OPTION_LABEL).set("checked",!1),t.hasOwnProperty("xaxis")&&t.xaxis!==""&&this._content.one(s.OPTION_XAXIS).setAttribute("value",t.xaxis),t.hasOwnProperty("yaxis")&&t.yaxis!==""&&this._content.one(s.OPTION_YAXIS).setAttribute("value",t.yaxis),t.hasOwnProperty("renderer")&&t.renderer!==""&&this._content.one(s.RENDERER_SELECTION).set("value",t.renderer),t.hasOwnProperty("custom")&&t.custom!==""&&(document.getElementById(r+"_"+i.OPTION_CONSOLE_COMMANDS).value=t.custom)},_resolveAnchors:function(){var t,n,r=this.get("host").getSelectionParentNode(),i,s;if(!r)return;n=this._findSelectedAnchors(e.one(r));if(n.length>0){t=n[0],this._currentSelection=this.get("host").getSelectionFromNode(t),i=t.getAttribute("target");var o=t.getAttribute("href"),u={},o=o.split("?"),s=o[0],a=o[1];o.length>1&&a.split("&").forEach(function(e){var t=e.split("=");u[t[0]]=decodeURIComponent(t[1])}),this._setProperties(s,u)}},_resolveAnchorsSketcher:function(){var t,n,o,u,a;a=this.get("host").getSelectionParentNode();if(!a)return;n=this._findSelectedAnchors(e.one(a));if(n.length>0){t=n[0],this._currentSelection=this.get("host").getSelectionFromNode(t),o=t.getAttribute("target");var f=t.getAttribute("href"),l={},f=f.split("?"),u=f[0],c=f[1];f.length>1&&c.split("&").forEach(function(e){var t=e.split("=");l[t[0]]=decodeURIComponent(t[1])});if(u!==""){var h=u.replace(/\\/g,"/");h=h.substring(h.lastIndexOf("/")+1,h.lastIndexOf(".")),h=decodeURIComponent(h),this._content.one(s.FILENAME_INPUT).setAttribute("value",h);var p=document.getElementById(r+"_"+i.CHEMDOODLE_SKETCHER);p.onload=function(){var t="#"+r+"_"+i.CHEMDOODLE_SKETCHER,n=e.one(t),s=e.Node.getDOMNode(n.get("contentWindow")),o=s.document;YUI({frame:n,win:s,doc:o}).use("node",function(e){s.clearCanvas(),s.setMOL(u)})}}l.hasOwnProperty("width")&&l.width>0&&this._content.one(s.OPTION_WIDTH).setAttribute("value",l.width),l.hasOwnProperty("height")&&l.height>0&&this._content.one(s.OPTION_HEIGHT).setAttribute("value",l.height),this._setProperties(u,l)}},_filepickerCallback:function(e){e.url!==""&&(this._content.one(s.URL_INPUT).set("value",e.url),this._updateOptions(this),this.markUpdated())},_setLink:function(t){var n,r=this.get("host"),i,o,u;t.preventDefault(),this.getDialogue({focusAfterHide:null}).hide(),i=this._content.one(s.URL_INPUT),u=i.get("value");if(u!==""){this.editor.focus(),r.setSelection(this._currentSelection),document.execCommand("unlink",!1,null),document.execCommand("createLink",!1,u),o=r.getSelectionParentNode();if(!o)return;n=this._findSelectedAnchors(e.one(o));var a=[],f,l=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")};e.Array.each(n,function(e){a=this._getParam(),f=u+"?"+l(a),e.setAttribute("href",f),e.set("innerHTML",decodeURIComponent(u.split("/").pop()))},this),this.markUpdated()}},_setSketcherLink:function(t){var n,o,u,a,f="#"+r+"_"+i.CHEMDOODLE_SKETCHER,l=e.one(f),c=e.Node.getDOMNode(l.get("contentWindow")),h=c.document;YUI({frame:l,win:c,doc:h}).use("node",function(e){o=c.getMOL()});var p=new Blob([o],{type:"plain/text"}),d=this._content.one(s.FILENAME_INPUT),v=d.get("value");if(v!=""){var m=this.get("host"),g=m.get("filepickeroptions").image,y=g.savepath===undefined?"/":g.savepath,b=new FormData;b.append("repo_upload_file",p,v+".mol"),b.append("itemid",g.itemid);var w=0;for(;;){if(g.repositories[++w]===undefined)break;if(g.repositories[w].type==="upload"){b.append("repo_id",g.repositories[w].id);break}}b.append("env",g.env),b.append("sesskey",M.cfg.sesskey),b.append("client_id",g.client_id),b.append("savepath",y),b.append("ctx_id",g.context.id);var E=new XMLHttpRequest;return E.onreadystatechange=function(){if(E.readyState===4)if(
E.status===200){var r=JSON.parse(E.responseText);if(r){if(r.error)return new M.core.ajaxException(r);var i=r;r.event&&r.event==="fileexists"&&(i=r.newfile),a=i.url;if(a!==""){t.preventDefault(),this.getDialogue({focusAfterHide:null}).hide();var s=this.get("host");this.editor.focus(),s.setSelection(this._currentSelection),document.execCommand("unlink",!1,null),document.execCommand("createLink",!1,a),u=s.getSelectionParentNode();if(!u)return;n=this._findSelectedAnchors(e.one(u));var o=[],f;serialize=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")},e.Array.each(n,function(e){o=this._getParam(),f=a+"?"+serialize(o),e.setAttribute("href",f),e.set("innerHTML",decodeURIComponent(a.split("/").pop()))},this),this.markUpdated()}}}else alert(M.util.get_string("servererror","moodle"))}.bind(this),E.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload",!1),E.send(b),!1}alert("Filename required")},_getParam:function(){var e=[],t,n;return t=this._content.one(s.OPTION_WIDTH),t.get("value")&&(e.width=t.get("value")),t=this._content.one(s.OPTION_HEIGHT),t.get("value")&&(e.height=t.get("value")),t=this._content.one(s.OPTION_DOWNLOAD_LINK),t&&t.get("checked")&&(e["download-link"]=1),t=this._content.one(s.OPTION_HELP_LINK),t&&t.get("checked")&&(e["help-link"]=1),t=this._content.one(s.OPTION_SPIN),t&&t.get("checked")&&(e.spin=1),t=this._content.one(s.OPTION_STYLESELECT),t&&t.get("checked")&&(e.styleselect=1),t=this._content.one(s.OPTION_LABEL),t&&t.get("checked")&&(e.label=1),t=this._content.one(s.OPTION_XAXIS),t&&t.get("value")&&(n=t.get("value"),e.xaxis=n),t=this._content.one(s.OPTION_YAXIS),t&&t.get("value")&&(n=t.get("value"),e.yaxis=n),t=this._content.one(s.RENDERER_SELECTION),t.get("value")&&(e.renderer=t.get("value")),t=this._content.one(s.OPTION_CONSOLE_COMMANDS),t.get("value")&&(n=t.get("value"),n=n.replace(/[^a-zA-Z0-9\u03ac-\u03c9\u0391-\u03ce\ \(\)\[\]\/\\\.\,\;\{\}\:]/gi,""),e.custom=n),e},_updatePreview:function(t){var n,r,i,o,u,a,f;r=this._content.one(s.URL_INPUT),f=r.get("value");if(f!==""){var l=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")};o=this._getParam(),a=f+"?"+l(o),i='<a href="'+a+'">test</a>',n=M.cfg.wwwroot+"/lib/editor/atto/plugins/chemrender/ajax.php",u={sesskey:M.cfg.sesskey,contextid:this.get("contextid"),action:"filtertext",text:i},e.io(n,{context:this,data:u,timeout:500,on:{complete:this._loadPreview}})}},_updateSketcherPreview:function(t){var n,r,i,o,u,a,f,l;r=this._content.one(s.CHEMDOODLE_SKETCHER_OUTPUT),l=r.get("value");if(l!==""){var c=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")};i=this._getParam(),a=l,f=window.location.origin,u=f+"/chemdoodle/preview.mol?"+c(i),n=M.cfg.wwwroot+"/lib/editor/atto/plugins/chemrender/ajax_sketcher.php",o={sesskey:M.cfg.sesskey,contextid:this.get("contextid"),action:"filtertext",paramstring:u,sketcheroutput:a},e.io(n,{method:"POST",context:this,data:o,timeout:500,on:{complete:this._loadPreview}})}},_updateOptions:function(e){var t,n;t=this._content.one(s.URL_INPUT),n=t.get("value").toLowerCase(),this._content.all(s.SPECTRUM_OPTIONS).each(function(e){e.hide()}),this._content.all(s.JMOL_OPTIONS).each(function(e){e.hide()}),this._content.all(s.SIZE_OPTIONS).each(function(e){e.hide()}),n.indexOf(".jdx")!=-1?this._content.all(s.SPECTRUM_OPTIONS).each(function(e){e.show()}):n.indexOf(".pdb")!=-1||n.indexOf(".cif")!=-1?this._content.all(s.JMOL_OPTIONS).each(function(e){e.show()}):n.indexOf(".mol")!=-1?this._content.all(s.SIZE_OPTIONS).each(function(e){e.show()}):this._content.all(s.SIZE_OPTIONS).each(function(e){e.show()});var r=this._content.one(s.RENDERER_SELECTION);r.get("value")&&r.get("value")=="jmol"&&this._content.all(s.JMOL_OPTIONS).each(function(e){e.show()})},_loadPreview:function(t,n){var o=this._content.one(s.PREVIEW_JMOL),u=this._content.one(s.RENDERER_SELECTION).get("value"),a=this._content.one(s.URL_INPUT).get("value").split(".").pop().toLowerCase();if(a=="pdb"||u=="jmol"){o.setHTML(n.responseText);var f=o.getElementsByTagName("script"),l=document.createElement("script");l.type="text/javascript";var c=[];for(var h=0;h<f._nodes.length;h++)f._nodes[h].src!=""?c.push(f._nodes[h].src):l.text=l.text+"\n"+f._nodes[h].innerHTML,f._nodes[h].parentNode.removeChild(f._nodes[h]);e.Get.js(c,function(e){if(e){console.log("Error loading JS: "+e[0].error,"error");return}o.appendChild(l)}),this._content.all(s.PREVIEW_CONTAINER).each(function(e){e.show()}),this._content.all(s.PREVIEW_CHEMDOODLE).each(function(e){e.hide()}),this._content.all(s.PREVIEW_JMOL).each(function(e){e.show()})}else{o.setHTML(n.responseText);var f=o.getElementsByTagName("script"),l=document.createElement("script");l.type="text/javascript";var c=[];for(var h=0;h<f._nodes.length;h++)f._nodes[h].src!=""?c.push(f._nodes[h].src):l.text=l.text+"\n"+f._nodes[h].innerHTML,f._nodes[h].parentNode.removeChild(f._nodes[h]);var p=o.get("innerHTML");o.setHTML(""),c.push(M.cfg.wwwroot+"/theme/yui_combo.php?rollup/3.15.0_1/yui-moodlesimple.js");var d="#"+r+"_"+i.PREVIEW_CHEMDOODLE,v=e.one(d),m=e.Node.getDOMNode(v.get("contentWindow")),g=m.document;YUI({frame:v,win:m,doc:g}).use("node",function(e){var t=e.one("body"),n=e.one("head");t.get("childNodes").remove(),t.append(p),c.forEach(function(e){var t=document.createElement("script");t.type="text/javascript",t.src=e,t.defer="defer",n.appendChild(t)}),setTimeout(function(){t.appendChild(l);var e,n;e=g.body.scrollHeight,n=g.body.scrollWidth,v.set("height",e+"px"),v.set("width",n+"px")},500)}),this._content.all(s.PREVIEW_CONTAINER).each(function(e){e.show()}),this._content.all(s.PREVIEW_JMOL).each(function(e){e.hide()}),this._content.all(s.PREVIEW_CHEMDOODLE).each(function(e){e.show()})}e.fire(M.core.event.FILTER_CONTENT_UPDATED,{nodes:new e.NodeList(o)});var y=document
.getElementsByClassName("moodle-dialogue-focused"),b=y[0];b.style.left=window.innerWidth/2-b.offsetWidth/2+"px"},_sketcherPreview:function(t){var n,s="#"+r+"_"+i.CHEMDOODLE_SKETCHER,o=e.one(s),u=e.Node.getDOMNode(o.get("contentWindow")),a=u.document;YUI({frame:o,win:u,doc:a}).use("node",function(e){n=u.getMOL()});var f=e.one("#"+r+"_"+i.CHEMDOODLE_SKETCHER_OUTPUT);return f.set("value",n),this._updateSketcherPreview(this),!1},_findSelectedAnchors:function(e){var t,n,r=e.get("tagName");return r&&r.toLowerCase()==="a"?[e]:(n=[],e.all("a").each(function(e){!t&&this.get("host").selectionContainsNode(e)&&n.push(e)},this),n.length>0?n:(t=e.ancestor("a"),t?[t]:[]))},_getDialogueContent:function(){var t=this.get("host").canShowFilepicker("link"),u=e.Handlebars.compile(o);return r=Math.round(Math.random()*1e9),this._content=e.Node.create(u({elementid:r,showFilepicker:t,component:n,CSS:i,wwwroot:M.cfg.wwwroot})),this._content.one(s.PREVIEW_BUTTON).on("click",this._updatePreview,this),this._content.one(s.URL_INPUT).on("valuechange",this._updateOptions,this),this._content.one(s.RENDERER_SELECTION).on("valuechange",this._updateOptions,this),this._content.one(s.SUBMIT_BUTTON).on("click",this._setLink,this),t&&this._content.one(s.FILE_BROWSER).on("click",function(e){e.preventDefault(),this.get("host").showFilepicker("link",this._filepickerCallback,this)},this),this._content.all(s.PREVIEW_CONTAINER).each(function(e){e.hide()}),this._content},_getSketcherDialogueContent:function(){var t=this.get("host").canShowFilepicker("link"),o=e.Handlebars.compile(u);return r=Math.round(Math.random()*1e9),this._content=e.Node.create(o({elementid:r,showFilepicker:t,component:n,CSS:i,wwwroot:M.cfg.wwwroot})),this._content.one(s.PREVIEW_SKETCHER_BUTTON).on("click",this._sketcherPreview,this),this._content.one(s.RENDERER_SELECTION).on("valuechange",this._updateOptions,this),this._content.one(s.SUBMIT_BUTTON).on("click",this._setSketcherLink,this),this._content.all(s.PREVIEW_CONTAINER).each(function(e){e.hide()}),this._content}},{ATTRS:{chemrenderfilteractive:{value:!1},contextid:{value:null}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});
